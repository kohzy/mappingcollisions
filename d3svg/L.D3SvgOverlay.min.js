/**
 * Copyright 2015 Teralytics AG
 *
 * @author Kirill Zhuravlev <kirill.zhuravlev@teralytics.ch>
 *
 */
(function(a){"function"===typeof define&&define.amd?define(["leaflet","d3"],a):"object"===typeof module&&module.exports?module.exports=a(require("leaflet","d3")):a(L,d3)})(function(a,e){if("undefined"==typeof e)throw"D3 SVG Overlay for Leaflet requires D3 library loaded first";if("undefined"==typeof a)throw"D3 SVG Overlay for Leaflet requires Leaflet library loaded first";"1.0"<=a.version&&e.select("head").append("style").attr("type","text/css").text("g.d3-overlay *{pointer-events:visiblePainted;}");a.D3SvgOverlay=("1.0">a.version?a.Class:a.Layer).extend({includes:"1.0">a.version?a.Mixin.Events:[],_undef:function(b){return"undefined"==typeof b},_options:function(b){if(this._undef(b))return this.options;b.zoomHide=this._undef(b.zoomHide)?!1:b.zoomHide;b.zoomDraw=this._undef(b.zoomDraw)?!0:b.zoomDraw;return this.options=b},_disableLeafletRounding:function(){this._leaflet_round=a.Point.prototype._round;a.Point.prototype._round=function(){return this}},_enableLeafletRounding:function(){a.Point.prototype._round=this._leaflet_round},draw:function(){this._disableLeafletRounding();this._drawCallback(this.selection,this.projection,this.map.getZoom());this._enableLeafletRounding()},initialize:function(b,a){this._options(a||{});this._drawCallback=b},_zoomChange:function(a){this._disableLeafletRounding();this._zoomDiff=(this._undef(a.zoom)?this.map._zoom:a.zoom)-this._zoom;this._scale=Math.pow(2,this._zoomDiff);this.projection.scale=this._scale;this._shift=this.map.latLngToLayerPoint(this._wgsOrigin)._subtract(this._wgsInitialShift.multiplyBy(this._scale));this._rootGroup.attr("transform",["translate(",this._shift.x,",",this._shift.y,") "].concat(["scale(",this._scale,",",this._scale,") "]).join(""));this.options.zoomDraw&&this.draw();this._enableLeafletRounding()},onAdd:function(b){this.map=b;var c=this;"1.0">a.version?(b._initPathRoot(),this._svg=e.select(b._panes.overlayPane).select("svg"),this._rootGroup=this._svg.append("g")):(this._svg=a.svg(),b.addLayer(this._svg),this._rootGroup=e.select(this._svg._rootGroup).classed("d3-overlay",!0));this._rootGroup.classed("leaflet-zoom-hide",this.options.zoomHide);this.selection=this._rootGroup;this._pixelOrigin=b.getPixelOrigin();this._wgsOrigin=a.latLng([0,0]);this._wgsInitialShift=this.map.latLngToLayerPoint(this._wgsOrigin);this._zoom=this.map.getZoom();this._shift=a.point(0,0);this._scale=1;this.projection={latLngToLayerPoint:function(b,d){d=c._undef(d)?c._zoom:d;return c.map.project(a.latLng(b),d)._round()._subtract(c._pixelOrigin)},layerPointToLatLng:function(b,d){d=c._undef(d)?c._zoom:d;var e=a.point(b).add(c._pixelOrigin);return c.map.unproject(e,d)},unitsPerMeter:256*Math.pow(2,c._zoom)/40075017,map:c.map,layer:c,scale:1};this.projection.latLngToLayerFloatPoint=this.projection.latLngToLayerPoint;this.projection.getZoom=this.map.getZoom.bind(this.map);this.projection.getBounds=this.map.getBounds.bind(this.map);this.selection=this._rootGroup;if("1.0">a.version)b.on("viewreset",this._zoomChange,this);this.draw()},getEvents:function(){return{zoomend:this._zoomChange}},onRemove:function(b){"1.0">a.version?(b.off("viewreset",this._zoomChange,this),this._rootGroup.remove()):this._svg.remove()},addTo:function(a){a.addLayer(this);return this}});a.D3SvgOverlay.version="2.1";a.d3SvgOverlay=function(b,c){return new a.D3SvgOverlay(b,c)}});
